<?php

/**
 * @file
 * User interface tweaks and other modifications for the Stanford Sites platform
 */

// How often system should check file system usage. 1 time a day.
define('SSH_QUOTA_CHECK_LIMIT', 60 * 60 * 24);
// Whole integer percentage in which to check against.
define('STANFORD_SUBSITE_HELPER_AFSQUOTA_THRESHOLD', 90);

/**
 * Implements hook_init().
 */
function stanford_sites_helper_init() {
  $path = drupal_get_path('module', 'stanford_sites_helper') . '/css/stanford-sites-helper.css';

  // Check to see if the quota is passed the threshold.
  // If it is then prompt the user with a message.
  if(!_is_ajax_request() && user_is_logged_in() && _stanford_sites_helper_check_quota()) {
    _stanford_sites_helper_set_quota_warning_message();
  }

}


/**
 * Implements hook_theme_registry_alter().
 */
function stanford_sites_helper_theme_registry_alter(&$theme_registry) {
  $theme_registry['search_results']['theme paths'] = array(0 => drupal_get_path('module', 'stanford_sites_helper') . '/templates');
  $theme_registry['search_results']['theme path'] = drupal_get_path('module', 'stanford_sites_helper') . '/templates';
  $theme_registry['search_results']['path'] = drupal_get_path('module', 'stanford_sites_helper') . '/templates';
  $theme_registry['search_results']['template'] = 'search-results';
  $theme_registry['block__stanford_sites_helper__firststeps']['theme paths'] = array(0 => drupal_get_path('module', 'stanford_sites_helper') . '/templates');
  $theme_registry['block__stanford_sites_helper__firststeps']['theme path'] = drupal_get_path('module', 'stanford_sites_helper') . '/templates';
  $theme_registry['block__stanford_sites_helper__firststeps']['path'] = drupal_get_path('module', 'stanford_sites_helper') . '/templates';
  $theme_registry['block__stanford_sites_helper__firststeps']['template'] = 'firststeps';
  $theme_registry['block__stanford_sites_helper__firststeps']['type'] = 'module';
}

/**
 * Returns a translatable string of help text for a search that returns no results.
 */
function stanford_sites_helper_search_noresults() {
  $content = '<ul>';
  $content .= '<li>' . t('Check if your spelling is correct.') . '</li>';
  $content .= '<li>' . t('Simplify your search by using fewer words.') . '</li>';
  $content .= '<li>' . t('Remove quotes around phrases to match each word individually: %stanfordquote will match less than %stanfordnoquote.', array('%stanfordquote' => '"stanford university"', '%stanfordnoquote' => 'stanford university')) . '</li>';
  $content .= '<li>' . t('Consider loosening your query with <em>OR</em>: <em>stanford university</em> will match less than <em>stanford OR university</em>.') . '</li>';
  $content .= '</ul>';
  return $content;
}

/**
 * Implements hook_block_info().
 */
function stanford_sites_helper_block_info() {
  $blocks['helplinks']['info'] = t('Display a list of help links specific to Stanford Sites');
  $blocks['helplinks']['properties']['administrative'] = 1;
  $blocks['helplinks']['status'] = 1;
  $blocks['helplinks']['region'] = 'help';
  $blocks['helplinks']['visibility'] = BLOCK_VISIBILITY_LISTED;
  $blocks['helplinks']['pages'] = "admin\nadmin/*";
  $blocks['firststeps']['info'] = t('Stanford Sites Welcome Text');
  $blocks['firststeps']['status'] = 1;
  $blocks['firststeps']['weight'] = 10;
  $blocks['firststeps']['region'] = 'content';
  $blocks['firststeps']['visibility'] = BLOCK_VISIBILITY_LISTED;
  $blocks['firststeps']['pages'] = "<front>";
  return $blocks;
}

/**
 * Implements hook_block_view().
 */
function stanford_sites_helper_block_view($delta) {
  switch ($delta) {
    case 'helplinks':
      $block['subject'] = t('Get Help');
      $block['content'] = t('Problems using this service? Submit a !helpsu. <hr />', array('!helpsu' => l('HelpSU request', 'http://remedyweb.stanford.edu/helpsu/2.0/helpsu-form?pcat=sites')));
      break;
    case 'firststeps':
      $block['subject'] = t('Quick Steps to Get Started');
      $block['content'] = '.';
      break;
  }
  return $block;
}

/**
 * Implements hook_menu().
 */
function stanford_sites_helper_menu() {
  $items['getting-started'] = array(
    'title' => 'Getting Started',
    'page callback' => 'theme',
    'page arguments' => array('firststeps_template'),
    'type' => MENU_NORMAL_ITEM,
    'access callback' => 'user_access',
    'access arguments' => array('administer site configuration'),
  );
  $items['admin/config/stanford-sites-helper/filequota/check'] = array(
    'title' => 'Check File Storage Quota',
    'page callback' => 'stanford_sites_helper_page_check_quota',
    'type' => MENU_CALLBACK,
    'access callback' => 'user_access',
    'access arguments' => array('administer site configuration'),
  );
  return $items;
}

/**
 * Page callback.
 */
function stanford_sites_helper_theme($existing, $type, $theme, $path) {
  return array(
    'firststeps_template' => array(
      'template' => 'templates/firststeps',
    ),
  );
}

/**
 * Implements hook_backup_migrate_profiles_alter().
 */
function stanford_sites_helper_backup_migrate_profiles_alter(&$profiles) {
  $profiles['default']->filters['sources']['files']['exclude_filepaths'] = 'backup_migrate
styles
css
js
ctools
.htaccess
tmp
private';
  $profiles['default']->filters['sources']['archive']['exclude_filepaths'] = 'public://backup_migrate
public://styles
public://css
public://js
public://ctools
public://less
sites/default/settings.php
sites/default/files/tmp
sites/default/files/private';
}

/**
 * Implements hook_backup_migrate_profiles().
 */
function stanford_sites_helper_backup_migrate_profiles() {
  //set this profile as default
  variable_set('backup_migrate_profile_id', 'stanford_sites_default');

  $out = array();

  // Get the stanford_sites_default profile.
  $out['stanford_sites_default'] = backup_migrate_crud_create_item('profile', array(
    'profile_id' => NULL,
    'machine_name' => 'stanford_sites_default',
    'name' => 'Stanford Sites Profile',
    'filename' => '[site:name]',
    'append_timestamp' => 1,
    'timestamp_format' => 'Y-m-d\\TH-i-s',
    'filters' =>
    array (
      'encryption' => 'none',
      'compression' => 'gzip',
      'notify_success_enable' => false,
      'notify_failure_enable' => false,
      'sources' =>
      array (
        'db' =>
        array (
          'nodata_tables' =>
          array (
            0 => 'cache',
            1 => 'cache_admin_menu',
            2 => 'cache_browscap',
            3 => 'cache_content',
            4 => 'cache_filter',
            5 => 'cache_calendar_ical',
            6 => 'cache_location',
            7 => 'cache_menu',
            8 => 'cache_page',
            9 => 'cache_reptag',
            10 => 'cache_views',
            11 => 'cache_views_data',
            12 => 'cache_block',
            13 => 'cache_update',
            14 => 'cache_form',
            15 => 'cache_bootstrap',
            16 => 'cache_field',
            17 => 'cache_image',
            18 => 'cache_path',
            19 => 'sessions',
            20 => 'search_dataset',
            21 => 'search_index',
            22 => 'search_keywords_log',
            23 => 'search_total',
            24 => 'watchdog',
            25 => 'accesslog',
            26 => 'devel_queries',
            27 => 'devel_times',
          ),
          'exclude_tables' =>
          array (
          ),
          'utils_lock_tables' => false,
        ),
        'files' =>
        array (
          'exclude_filepaths' => 'backup_migrate
  styles
  css
  js
  ctools
  .htaccess
  tmp
  private',
        ),
        'archive' =>
        array (
          'exclude_filepaths' => 'public://backup_migrate
  public://styles
  public://css
  public://js
  public://ctools
  public://less
  sites/default/settings.php
  sites/default/files/tmp
  sites/default/files/private',
        ),
      ),
      'utils_disable_query_log' => true,
      'utils_site_offline' => false,
      'utils_description' => '',
    ),
    'type_name' => 'profile',
  )
  );

  return $out;

}

/**
 * Fix spell check as you type (scayt) autostart behavior.
 * See http://drupal.org/node/817894 for reference.
 */
function stanford_sites_helper_wysiwyg_editor_settings_alter(&$settings, $context) {
  if ($context['profile']->editor == 'ckeditor') {
    $settings['scayt_autoStartup'] = FALSE;
  }
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function stanford_sites_helper_form_user_pass_alter(&$form, &$form_state, $form_id) {
  $message = t('If you are having difficulty resetting your password, please !submithelpsu.', array('!submithelpsu' => l('submit a HelpSU request', 'https://helpsu.stanford.edu/?pcat=sites')));
  $form['name']['#suffix'] = $message;
}

/**
 * Implements hook_file_insert().
 */
function stanford_sites_helper_file_insert($file) {

  // Every time a new file is saved we should run the check quota.
  variable_set('stanford_sites_helper_afsquota_threshold_bool', 0);
  variable_set('stanford_sites_helper_afsquota_ts', 0);

  if (_stanford_sites_helper_check_quota()) {
    _stanford_sites_helper_set_quota_warning_message();
  }
}

/**
 * Implements hook_file_update().
 */
function stanford_sites_helper_file_update($file) {

  // Every time a new file is updated we should run the check quota.
  variable_set('stanford_sites_helper_afsquota_threshold_bool', 0);
  variable_set('stanford_sites_helper_afsquota_ts', 0);

  if (_stanford_sites_helper_check_quota()) {
    _stanford_sites_helper_set_quota_warning_message();
  }
}

/**
 * Implements hook_file_delete().
 */
function stanford_sites_helper_file_delete($file) {
  // Every time a file is deleted we should reset the clock.
  variable_set('stanford_sites_helper_afsquota_threshold_bool', 0);
  variable_set('stanford_sites_helper_afsquota_ts', 0);
}

/**
 * Implements hook_mail
 */
function stanford_sites_helper_mail($key, &$message, $params) {
  switch ($key) {
    case 'afsquota_warning':
      $usage = _stanford_sites_helper_get_usage();
      $site_url = url("<front>", array('absolute' => TRUE));

      $message['headers']['Content-Type'] = 'text/html; charset=UTF-8; format=flowed';

      $message['subject'] = "You are nearing your storage limit on " . $params['site_name'];
      //$message['body'][] = url('<front>', array('absolute' => TRUE)) . " is nearing the file storage limit. Currently, " . $usage . "% of your allocated storage is being used. Please submit a file storage increase request to HelpSU or your website may experience issues and possible downtime. To request a storage increase please use the HelpSU request form found at: http://helpsu.stanford.edu/?pcat=sites. \n\nThank you,\nStanford Sites Team";
      $message['body'][] = "<p>****************** DO NOT REPLY TO THIS AUTOMATED MESSAGE ******************</p>";
      $message['body'][] = "<p><strong>You are currently using " . $usage . "% of your available disk space for documents and images on " . l($site_url, $site_url) . ".</strong></p>";
      $message['body'][] = "<p>If you exceed your disk space limit, you may encounter errors when trying to upload files to your site.";
      $message['body'][] = "<p>Additional disk space is available at no charge. Please submit a HelpSU request at " .  l("http://helpsu.stanford.edu/?pcat=sites", "http://helpsu.stanford.edu/?pcat=sites") . " to increase your limit.</p>";
      $message['body'][] = "<p>If you think this message is incorrect or the issue has been resolved, you can try checking again. " . l('Check available space.', 'admin/config/stanford-sites-helper/filequota/check', array('absolute' => TRUE)) . "</p>";
      $message['body'][] = "<p>****************** DO NOT REPLY TO THIS AUTOMATED MESSAGE ******************</p>";

      break;
  }
}


// -----------------------------------------------------------------------------
// AFS QUOTA CHECK HELPERS -----------------------------------------------------
// -----------------------------------------------------------------------------

/**
 * url: admin/config/stanford-sites-helper/filequota/check
 * A page to manually check the quota available. Provides additional
 * information and bypasses the limit check.
 * @return  'string' page markup
 */
function stanford_sites_helper_page_check_quota() {
  $output = '';

  variable_set('stanford_sites_helper_afsquota_threshold_bool', 0);
  variable_set('stanford_sites_helper_afsquota_ts', 0);

  $check = _stanford_sites_helper_check_quota();

  if($check){
    $output .= "<h3 class=\"warning\">" . t('You are nearing your file storage limit. Please submit a ') . l('HelpSU request' , 'http://helpsu.stanford.edu/?pcat=sites') . t(' for more storage.') . "</h3>";
  }
  else {
    $output .= "<h3>" . t('No problems here!') . "</h3><p>" . t('You are well under your file storage limit. Please carry on your site tasks as normal. For more information please see the ') . l('site status report page.', 'admin/reports/status') . "</p>";
  }

  return $output;
}

/**
 * Returns the quota boolean. Quota boolean is a switch for under or over quota.
 * @return [type] [description]
 */
function _stanford_sites_helper_get_quota_bool() {
  return variable_get('stanford_sites_helper_afsquota_threshold_bool', 0);
}

/**
 * Check quota function performs the file system storage usage check. If the
 * qouta threshold has been surpassed an email is sent to user 1 and a message
 * is prompted to administration users.
 * @return boolean - True for over threshold.
 */
function _stanford_sites_helper_check_quota() {

  global $argv;

  // Check if we need to check.
  $last_check = variable_get('stanford_sites_helper_afsquota_ts', 0);
  $is_install = (isset($argv) && $argv[3] == "si") ? TRUE : FALSE;
  if(($last_check + SSH_QUOTA_CHECK_LIMIT) < time() && !$is_install) {
    $usage = _stanford_sites_helper_get_usage();
    if($usage >= STANFORD_SUBSITE_HELPER_AFSQUOTA_THRESHOLD) {
      variable_set('stanford_sites_helper_afsquota_threshold_bool', 1);

      $have_i_sent_email = variable_get('stanford_sites_helper_afsquota_sent_email', 0);
      if($have_i_sent_email == 0) {
        _stanford_sites_helper_send_warning_email();
        variable_set('stanford_sites_helper_afsquota_sent_email', 1);
      }
      return TRUE;
    }
    else {
      // Quota is back to being ok. Reset warning bool and email notification.
      variable_set('stanford_sites_helper_afsquota_threshold_bool', 0);
      variable_set('stanford_sites_helper_afsquota_sent_email', 0);
      return FALSE;
    }
  }

  // See if the quota message has been tiggered.
  // If it has then we return.
  if(_stanford_sites_helper_get_quota_bool()) {
    return TRUE;
  }

  return FALSE;
}

/**
 * Returns an array of information about file system usage
 * @return array - An array of information
 * - volume name
 * - quota in bits
 * - used space in bits
 * - used percentage
 * - Total disk usage percentage
 */
function _stanford_sites_helper_get_usage_info() {
  variable_set('stanford_sites_helper_afsquota_ts', time());  $raw = shell_exec(escapeshellcmd('fs lq sites/default/files'));

  // Volume Name | Quota | Used | %Used | Partition
  // list($volume_name, $max_quota, $bytes_used, $percentage_used, $partition_usage) = explode($raw, " ");

  $keys = array(
    'volume_name',
    'max_bits_quota',
    'bits_used',
    'percentage_used',
    'partition_usage',
  );

  $results = preg_split('/[\r\n]+/', $raw, -1, PREG_SPLIT_NO_EMPTY);
  if (!isset($results[1])) {
    throw new Exception("Could not get file storage data.");
  }
  $data = preg_split('/ +/', trim($results[1]));

  // If for some reason the above processing does not produce an array of
  // information we should throw out an exception.
  if(!is_array($data) || count($data) < 5) {
    throw new Exception("Could not get file storage data.");
  }

  // remove anything but numbers from data
  $data[3] = preg_replace('/[^0-9]/', '', $data[3]);
  $data[4] = preg_replace('/[^0-9]/', '', $data[4]);

  // Ensure only 5 pieces of data.
  $data = array_slice($data, 0, 5);

  // Key the data and return to caller.
  return array_combine($keys, $data);
}

/**
 * Returns the percentage of disk usage.
 * @return integer
 */
function _stanford_sites_helper_get_usage() {

  try{
    $info = _stanford_sites_helper_get_usage_info();
  }
  catch (Exception $e) {
    watchdog('stanford_sites_helper', 'Error getting file storage data. Possibly could not execute shell function or shell function does not exist.');
    return 0;
  }

  variable_set('stanford_sites_helper_afsquota_current', $info['percentage_used']);
  return $info['percentage_used'];
}

/**
 * Creates a user message for adminstrators to let them know that their afs
 * storage is nearing its limit.
 */
function _stanford_sites_helper_set_quota_warning_message() {

  global $user;

  // Do not add message for non authenticated users.
  if(!user_is_logged_in()) {
    return;
  }

  $accepted_roles = variable_get('stanford_sites_helper_afsquota_roles', array('administrator'));
  $check = array_intersect($accepted_roles, array_values($user->roles));

  // Do not add message for non admin type users.
  if(!$check) {
    return;
  }

  $usage = _stanford_sites_helper_get_usage();

  $message = t('You are currently using ' . $usage . '% of your available storage. Please submit a ') . l('HelpSU' , 'http://helpsu.stanford.edu/?pcat=sites') . t(' request for more storage. If you think this message is incorrect and the issue has been resolved try ') . l('checking again', 'admin/config/stanford-sites-helper/filequota/check') . ".";
  drupal_set_message($message, 'warning', FALSE);

}

/**
 * Sends an email about the status of the AFS storage usage to user 1
 * or the passed in array of emails.
 * @param  array  $emails an array of email accounts to send the email to.
 * @return boolean - True for success
 */
function _stanford_sites_helper_send_warning_email($emails = array()) {

  $to = !empty($emails) ? implode(",", $emails) : _stanford_sites_helper_get_user_1_email();
  $site_name = variable_get('site_name', 'Your Website');
  $from = $site_name . ' <no-reply@stanford.edu>';
  $params = array('site_name' => $site_name);
  $language = language_default();
  $my_module = 'stanford_sites_helper';
  $my_mail_token = 'afsquota_warning';
  $message = array();
  stanford_sites_helper_mail($my_mail_token, $message, $params);
  $body = drupal_wrap_mail(implode("",$message['body']));
  $subject = $message['subject'];

  //  return drupal_mail('stanford_sites_helper', 'afsquota_warning', $to, $language, $params, $from);

  // $system = drupal_mail_system($my_module, $my_mail_token);
  // if ($system->mail($message)) {
  //   watchdog('stanford_sites_helper', 'Sent AFS Storage Warning Email.', array($system), WATCHDOG_NOTICE);
  // }
  // else {
  //   watchdog('stanford_sites_helper', 'FAILED TO SEND AFS Storage Warning Email.', array($system), WATCHDOG_ERROR);
  //   print_r($system->error);
  // }

   // To send HTML mail, the Content-type header must be set
  $headers  = 'MIME-Version: 1.0' . "\r\n";
  $headers .= 'Content-type: text/html; charset=iso-8859-1' . "\r\n";

  // Additional headers
  $headers .= 'From:' . addslashes($from) . "\r\n";

  mail($to, $subject, $body, $headers);
}

/**
 * Returns user 1's email address
 * @return string - email address
 */
function _stanford_sites_helper_get_user_1_email() {
  $user = user_load(1);
  return $user->mail;
}

/**
 * Small helper function to check to see if request was an ajax request.
 * @return boolean [description]
 */
function _is_ajax_request() {
  return !empty($_SERVER['HTTP_X_REQUESTED_WITH']) && strtolower($_SERVER['HTTP_X_REQUESTED_WITH']) == 'xmlhttprequest';
}

